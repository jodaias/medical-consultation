// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String
  phone         String?
  dateOfBirth   DateTime?
  gender        Gender?
  userType      UserType @default(PATIENT)
  isVerified    Boolean  @default(false)
  isActive      Boolean  @default(true)
  profileImage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Doctor specific fields
  doctorProfile DoctorProfile?

  // Patient specific fields
  patientProfile PatientProfile?

  // Relations
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  consultations    Consultation[] @relation("PatientConsultations")
  doctorConsultations Consultation[] @relation("DoctorConsultations")
  schedules       Schedule[]
  doctorPrescriptions Prescription[] @relation("DoctorPrescriptions")
  patientPrescriptions Prescription[] @relation("PatientPrescriptions")
  ratings         Rating[]
  receivedRatings Rating[] @relation("DoctorRatings")

  @@map("users")
}

model DoctorProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  crm             String   @unique
  specialty       String
  experience      Int      // years of experience
  education       String[]
  certifications  String[]
  bio             String?
  consultationFee Decimal  @db.Decimal(10, 2)
  availability    Json     // Store availability as JSON
  isAvailable     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("doctor_profiles")
}

model PatientProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  emergencyContact String?
  allergies       String[]
  medicalHistory  String?
  currentMedications String[]
  insurance       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("patient_profiles")
}

model Consultation {
  id          String           @id @default(cuid())
  patientId   String
  doctorId    String
  status      ConsultationStatus @default(SCHEDULED)
  scheduledAt DateTime
  startedAt   DateTime?
  endedAt     DateTime?
  notes       String?
  diagnosis   String?
  prescription String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  patient User @relation("PatientConsultations", fields: [patientId], references: [id])
  doctor  User @relation("DoctorConsultations", fields: [doctorId], references: [id])
  messages Message[]
  prescriptions Prescription[]

  @@map("consultations")
}

model Message {
  id             String   @id @default(cuid())
  consultationId String
  senderId       String
  receiverId     String
  content        String
  messageType    MessageType @default(TEXT)
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  sender      User        @relation("SentMessages", fields: [senderId], references: [id])
  receiver    User        @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@map("messages")
}

model Schedule {
  id            String   @id @default(cuid())
  doctorId      String
  dayOfWeek     Int      // 0-6 (Sunday-Saturday)
  startTime     String   // Format: "HH:MM"
  endTime       String   // Format: "HH:MM"
  isAvailable   Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  doctor User @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("schedules")
}

model Prescription {
  id             String   @id @default(cuid())
  consultationId String
  doctorId       String
  patientId      String
  medications    Json     // Array of medications
  instructions   String
  dosage         String
  duration       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  doctor      User        @relation("DoctorPrescriptions", fields: [doctorId], references: [id])
  patient     User        @relation("PatientPrescriptions", fields: [patientId], references: [id])

  @@map("prescriptions")
}

model Rating {
  id             String   @id @default(cuid())
  patientId      String
  doctorId       String
  consultationId String?
  rating         Int      // 1-5 stars
  comment        String?
  createdAt      DateTime @default(now())

  patient      User        @relation(fields: [patientId], references: [id])
  doctor       User        @relation("DoctorRatings", fields: [doctorId], references: [id])

  @@map("ratings")
}

enum UserType {
  PATIENT
  DOCTOR
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ConsultationStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  AUDIO
}